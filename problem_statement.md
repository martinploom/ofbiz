# Backend not working with proxy inside docker container

The repository is https://github.com/martinploom/ofbiz and branch is feature/marketdata_backend.

The branch has working backend which runs on local PC running the command `./gradlew cleanAll loadAll ofbiz` which can be used via https://localhost:8443/ordermgr

Next I build the docker image from the [Dockerfile](Dockerfile) using command 

`docker build -t back .`

After that I create and run the container using the command

`docker run -dit --name back -p 8443:8443 back`

After waiting some minutes I can access the https://localhost:8443/ordermgr

Also, the Postman POST https://localhost:8443/api/auth/v1/login for authentication works and GET https://localhost:8443/api/generic/v1/entities requests with JWT token works.

Activating reverse proxy which is running in local PC, not in the container with the following conf (this conf works with Ofbiz running without container when the [aurelia front marketdata_develop branch](https://github.com/martinploom/ofbiz-ui/tree/marketdata_develop) is launced with `au run` and they can communicate with each other so login and data requests work):
```terminal
##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# https://www.nginx.com/resources/wiki/start/
# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
# https://wiki.debian.org/Nginx/DirectoryStructure
#
# In most cases, administrators will remove this file from sites-enabled/ and
# leave it as reference inside of sites-available where it will continue to be
# updated by the nginx packaging team.
#
# This file will automatically load configuration files provided by other
# applications, such as Drupal or Wordpress. These applications will be made
# available underneath a path with that package name, such as /drupal8.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

# Default server configuration
#
server {
	listen 80;

	# SSL configuration
	#
	# listen 443 ssl default_server;
	# listen [::]:443 ssl default_server;
	#
	# Note: You should disable gzip for SSL traffic.
	# See: https://bugs.debian.org/773332
	#
	# Read up on ssl_ciphers to ensure a secure configuration.
	# See: https://bugs.debian.org/765782
	#
	# Self signed certs generated by the ssl-cert package
	# Don't use them in a production server!
	#
	# include snippets/snakeoil.conf;

	root /var/www/html;

	# Add index.php to the list if you are using PHP
	index index.html index.htm index.nginx-debian.html;

	server_name localhost;

	location / {
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		proxy_pass http://localhost:6060;
	}

	location /api/ {
		proxy_pass https://localhost:8443;
	}

	# pass PHP scripts to FastCGI server
	#
	#location ~ \.php$ {
	#	include snippets/fastcgi-php.conf;
	#
	#	# With php-fpm (or other unix sockets):
	#	fastcgi_pass unix:/var/run/php/php7.2-fpm.sock;
	#	# With php-cgi (or other tcp sockets):
	#	fastcgi_pass 127.0.0.1:9000;
	#}

	# deny access to .htaccess files, if Apache's document root
	# concurs with nginx's one
	#
	#location ~ /\.ht {
	#	deny all;
	#}
}


# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
#server {
#	listen 80;
#	listen [::]:80;
#
#	server_name example.com;
#
#	root /var/www/example.com;
#	index index.html;
#
#	location / {
#		try_files $uri $uri/ =404;
#	}
#}
```

After activating the reverse proxy I can still login to backend using https://localhost:8443/ordermgr in the browser and the Postman requests still work nicely.
When trying to access the back via proxy http://localhost/api/ordermgr it says **404 Not found** ...

The Postman POST requests against http://localhost/api/auth/v1/login works, and I get token back and GET also works for http://localhost/api/generic/v1/entities

Running the frontend with `au run` without Docker container, I can log in and everything works nicely.

The problem currently with Postman POST and GET requests was, that I used http://localhost/api/api/auth/v1/login which had one `/api` too much.

Now, that locally the back in container and front with `au run` is working with the proxy configuration mentioned above, I will try putting the front in container as well.

The front used is [here](https://github.com/martinploom/ofbiz-ui/tree/marketdata_develop) under branch marketdata_develop and the this is the [Dockerfile](https://github.com/martinploom/ofbiz-ui/blob/marketdata_develop/Dockerfile) and the [NGINX proxy conf](https://github.com/martinploom/ofbiz-ui/blob/marketdata_develop/deploy/nginx/default.conf) is here that is used inside the frontend container, so the proxy is running inside the container.

Building the frontend Docker image

`docker build -t front .`

Then I run the container

`docker run -dit --name front -p 80:80 front`

After that I can access the front from browser via http://localhost (the proxy inside container is running), but when trying to log in I get **502 Bad Gateway** when inspecting chrome Network requests. The https://localhost:8443/ordermgr still works in browser. But the Postman POST method for login to http://localhost/api/auth/v1/login with same settings as before does not work anymore.

Will try connecting the containers into one network and see what happens then. 

Creating the network

`docker network create mynetwork`

Adding front and back to it

`docker network connect mynetwork back`

`docker network connect mynetwork front`

After that I still get **502 Bad Gateway** when trying to access back via proxy with Postman POST login request.

When I go into back container with

`docker exec -it back /bin/sh`

Install curl

`apt install curl`

And try to ping frontend container

`curl http://front`

I receive the front HTML raw data.

When going into front container with 

`docker exec -it front /bin/sh`

Adding curl to front container
`apk add curl`

And trying to ping back

`curl https://back:8443/ordermgr`

I get that there is SSL cert problem, so I run the same command with `-k` flag

`curl -k https://back:8443/api/generic/v1/entities` 

I get the following response

`{"statusCode":401,"statusDescription":"Unauthorized","errorMessage":"Unauthorized: Access is denied due to invalid or absent Authorization header"}`

Which is to be expected as there is no login header. So the back can be accessed from front container as well it seems.

Running command 

`nginx -t`

to check which conf file is used by NGINX in front container and the response is following:
`/etc/nginx/nginx.conf`

Going to the file

`cd /etc/nginx/`

and installing nano

`apk add nano`

and going into it with `nano nginx.conf` I do not see the server conf, although the `default.conf` should be imported. Changed the `https://localhost:8443` to `https://back:8443` and restarted the nginx with `nginx -s reload` and then I got response from the back via Postman POST login method ... and the stuff works in browser as well.

So all in all, it finally works in server as well. The possible solutions were
1. `https://localhost:8443` instead of `https://localhost:8443/` which got it locally working with proxy being not in container
    1. Do not know why the [guide](https://medium.com/@codingwithmanny/create-an-nginx-reverse-proxy-with-docker-a1c0aa9078f1) said that the slash at the end is a must have, as it broke everything ...
    1. When I readd the final `/`, then the proxy is broken again, so it is important to **NOT ADD IT**!
1. Inside the container use `https://back:8443` as localhost doesn't work ...
    1. I think I tried out before as Tavo suggested, but maybe I had the last slash or at some point the containers were named `ofbiz_front` and `ofbiz_back` and the browser read that there can be no `_` inside url.
    

Final questions regarding the problem, what I do not understand yet.
1. Why didn't `localhost` work and `back` worked?
1. Why didn't it work with final `/`?
